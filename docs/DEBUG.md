# デバッグ方法

## 「PCでは動くが、モバイルや Codespaces ではエラーになる」場合

**PC では正常に動いている**のに、**モバイルのブラウザ**や **GitHub Codespaces** で開くと「GEMINI_API_KEYが設定されていません」と出ることがあります。

### 理由

- **PC（ローカル）**  
  同じフォルダに `.env` があり、その中に `GEMINI_API_KEY` が書いてあるため、アプリが動きます。
- **Codespaces**  
  `.env` は **Git に含まれていません**（`.gitignore` で除外しているため）。  
  Codespaces はリポジトリをクローンした状態なので、**その環境には `.env` が存在しません**。  
  そのため、Codespaces 上で開いたときだけ API キー未設定エラーになります。
- **モバイルで同じ URL（PC で起動した Streamlit）にアクセスしている場合**  
  サーバーは PC 上の同じプロセスなので、API キーは読み込まれています。  
  この場合は「キーが無い」ではなく、**別の要因**（画面のエラー表示や、モバイルでのスクリプト読み込み失敗など）の可能性があります。

### 対処

- **Codespaces でも動かしたい場合**  
  Codespaces の環境にだけ、次のどちらかで API キーを渡してください。
  1. Codespaces 内で、プロジェクト直下に `.env` を新規作成し、`GEMINI_API_KEY=あなたのキー` を書く。
  2. リポジトリの **Settings → Secrets and variables → Codespaces** で `GEMINI_API_KEY` を追加する（推奨。キーをリポジトリに含めずに済みます）。
- **モバイルで「APIキーが設定されていません」と出る場合**  
  アクセスしている URL が **PC の Streamlit** なら、サーバー側にはキーがあるはずです。  
  その場合は、モバイルのブラウザのキャッシュ削除や、別ブラウザでのアクセスを試すと原因の切り分けになります。

---

## Python のトレースバックを確認するには

Streamlit の**画面上には、通常は Python のトレースバックは出ません**。  
エラー時には「エラー: GEMINI_API_KEY環境変数が設定されていません。」のようなメッセージだけが表示されます。

### トレースバックを見る場所

1. **ターミナル（推奨）**  
   `streamlit run app.py` を実行した**同じターミナル**に、Python のトレースバックが表示されます。
   - ローカル: コマンドを実行したターミナル
   - Codespaces: 下部の「ターミナル」パネルで `streamlit run app.py` を実行したタブ

2. **Streamlit の画面**  
   起動中に例外が発生した場合、アプリ側でトレースバックを表示する処理を入れています。  
   その場合は画面上のコードブロックにトレースバックが出ます。

### API キーエラーについて

「GEMINI_API_KEY環境変数が設定されていません」と出ている場合は、**API キーが未設定**です。  
この状態ではアプリは動かず、他の機能も試せません。

- **ローカル / Codespaces**  
  プロジェクト直下に `.env` を作成し、次の1行を追加してください。  
  `GEMINI_API_KEY=あなたのAPIキー`
- **Streamlit Cloud**  
  アプリの Settings → Secrets に  
  `GEMINI_API_KEY = "あなたのAPIキー"`  
  を追加してください。
- **GitHub Codespaces**  
  リポジトリの Settings → Secrets and variables → Codespaces で  
  `GEMINI_API_KEY` を追加すると、環境変数として自動で渡されます。

`.env` は `.gitignore` に入っているため、Git にはコミットされません。

---

## モバイルで「TypeError: Importing a module script failed」が出る場合

このエラーは **Python 側ではなく、モバイルのブラウザが JavaScript を読み込むときに失敗している**ために出ます。  
そのため **サーバーのターミナルにはトレースバックは出ません**（お示しするものがない状態で正常です）。

### 原因のイメージ

- Streamlit のフロントエンド（JS）を「動的インポート」で読み込む際、モバイルのブラウザやネット・キャッシュの影響で読み込みに失敗することがある
- Streamlit の既知の事象として、本番環境やモバイルでときどき報告されている

### 試せる対策（いずれも「確実に直る」保証はありません）

1. **モバイルのブラウザのキャッシュを削除してから、同じ URL を再度開く**
2. **モバイルで別ブラウザを使う**（例: Chrome で出るなら Safari、その逆など）
3. **「PC版サイト」表示にして開き直す**（モバイルブラウザのメニューから）
4. **Streamlit を最新に上げる**  
   手順は下の「Streamlit を最新に更新する手順」を参照。
5. **何度かリロードする**  
   同じ環境でも、再読み込みで成功することがあります（一時的な読み込み失敗の可能性があるため）
6. **デプロイ先が Streamlit Cloud の場合**  
   Streamlit のバージョンや Cloud 側の不具合の影響もあり得るため、[Streamlit のフォーラム](https://discuss.streamlit.io/)や [GitHub Issues](https://github.com/streamlit/streamlit/issues) で「Importing a module script failed」や「Failed to fetch dynamically imported module」を検索し、同じ事象の報告や回避策がないか確認する

現時点では、**アプリ側のコードでこのエラーを確実に防ぐ方法はありません**。上記のような「環境・ブラウザ・キャッシュ・バージョン」まわりの対処が中心になります。

### Streamlit を最新に更新する手順（詳しく）

**「プロジェクトフォルダ」とは**  
このアプリのソースが入っている**一番上のフォルダ**のことです。  
中に `app.py` や `requirements.txt`、`config.py` などが同じ階層で見えている場所です。

- **ローカル（自分のPC）で開いている場合:** 例）`familyship-ai-concierge` という名前のフォルダを開いているなら、そのフォルダがプロジェクトフォルダです。
- **GitHub Codespaces の場合:** たいていターミナルを開いたとき、すでに `~/workspaces/familyship-ai-concierge` のようなプロジェクトフォルダの中にいます。

**作業場所:** ここで説明するコマンドは、**そのプロジェクトフォルダの中**で実行します。  
使うのは、VS Code / Cursor の「ターミナル」、または GitHub Codespaces の「ターミナル」パネルです。

---

#### ステップ1: いま動いている Streamlit を止める

1. **Streamlit を起動しているターミナル**を開く。
2. そのターミナルでキーボードの **`Ctrl + C`**（Mac では **`Control + C`**）を押す。
3. 「Streamlit が終了しました」のように表示され、入力できる状態（`$` や `%` のプロンプト）に戻れば OK。

※ 別のターミナルで実行している場合は、そのタブを選んでから `Ctrl + C` を押してください。

---

#### ステップ2: Streamlit を最新版に更新する（やり方）

**2-1. ターミナルを開く**

- **VS Code / Cursor の場合**  
  画面上部のメニューから **「ターミナル」→「新しいターミナル」** をクリック。  
  またはキーボードで **Ctrl + `**（バッククォート。キーの左上にある「`」）を押す。
- **GitHub Codespaces の場合**  
  同じく **「ターミナル」→「新しいターミナル」** でOKです。

→ 画面の**下**か**横**に、黒や青っぽい窓（ターミナル）が開き、  
　最後の行に `$` や `%` やパスが表示され、カーソルが点滅している状態になります。

---

**2-2. プロジェクトフォルダにいるか確認する（任意）**

ターミナルに次の文字を**そのまま**打ち、**Enter** を押します。

```
pwd
```

- 表示されたパスの**最後**に `familyship-ai-concierge` が出ていれば、そのまま **2-3** へ。
- 違うフォルダ名だった場合:
  - **Codespaces:** 次のように打って Enter → その後 **2-3** へ。
    ```
    cd /workspaces/familyship-ai-concierge
    ```
  - **ローカル（例: ダウンロードフォルダにある場合）:** 次のように打って Enter → その後 **2-3** へ（パスは環境に合わせて変えてください）。
    ```
    cd ~/Downloads/ファミシプコンシェルジュ/familyship-ai-concierge
    ```

---

**2-3. コマンドを打って実行する**

1. ターミナルの**入力できる場所**（`$` の右など）をクリックして、カーソルを置く。
2. 次の文字を**コピー＆ペースト**するか、手で打ちます。  
   （前後の余計な空白や改行は入れないでください。）

   ```
   pip install -U streamlit
   ```

3. **Enter キー**を1回押す。
4. しばらく待つ（数十秒かかることがあります）。
5. 最後の方に **`Successfully installed streamlit-〇.〇.〇`** のような行が出ていれば**成功**です。

- **「pip が見つかりません」と出た場合**  
  代わりに次を打って Enter を押してみてください。  
  ```
  pip3 install -U streamlit
  ```
- **赤い文字でエラー**が出た場合は、そのメッセージをそのままコピーして、誰かに見せると原因を特定しやすくなります。

---

#### ステップ3: Streamlit を再度起動する

同じターミナルで、いつもどおり起動します。

```bash
streamlit run app.py --server.enableCORS false --server.enableXsrfProtection false
```

- **Codespaces で別オプションを使っている場合**は、普段使っているコマンドで問題ありません。
- 起動に成功すると、次のようなメッセージが出ます。
  - `Local URL: http://localhost:8501`
  - `Network URL: http://10.x.x.x:8501`
  - `External URL: http://xxx.xxx.xxx.xxx:8501`（Codespaces の場合など）

この **URL** をメモしておきます（モバイルで開くときに使います）。

---

#### ステップ4: モバイルから再度アクセスする

1. **モバイルと PC（または Codespaces）が同じ Wi‑Fi にいる場合**
   - PC のターミナルに表示された **Network URL**（`http://10.x.x.x:8501`）を、モバイルのブラウザのアドレス欄にそのまま入力して開く。
   - ローカルで実行している場合は、PC の IP アドレスが `192.168.x.x` のとき、`http://192.168.x.x:8501` のようにして開く場合もあります。

2. **Codespaces で実行している場合**
   - ブラウザで「ポート」パネルを開き、ポート **8501** の「Public」や「Open in Browser」の URL をコピーする。
   - その URL をモバイルのブラウザで開く（モバイルとインターネット経由でアクセスする形になります）。

3. **一度キャッシュを避けて開く**
   - モバイルのブラウザで **シークレット（プライベート）モード** で、上記の URL を開いてみる。
   - または、そのサイトの **キャッシュ・データを削除** してから、同じ URL を再度開く。

---

#### うまくいかないとき

- ターミナルに **エラー（赤い文字）** が出た場合は、そのメッセージをそのままコピーして、サポートに貼ると原因を特定しやすくなります。
- 「`pip` が見つからない」と出る場合は、`pip3 install -U streamlit` を試してください。
- モバイルで「接続できない」と出る場合は、PC とモバイルが **同じネットワーク** か、Codespaces の **ポート 8501 が公開されているか** を確認してください。
